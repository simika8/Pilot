
## 004 Adatbázis kapcsolat

### #14 Bl class library létrehozása
- sollution / Add / new project / Class Library : Bl
- Class1 törlése


- NuGet csomag telepítése: Npgsql.EntityFrameworkCore.PostgreSQL (6.0.0)
- NuGet csomag telepítése: Microsoft.EntityFrameworkCore.Design (6.0.0)

- Controllers / Add / Project reference / Bl
- Bl / Add / Project reference / ```Models```

- git commit

- Ef core telepítése (futtatni Bl könyvtárban)
    
    ```dotnet tool install --global dotnet-ef```

    ```dotnet tool update --global dotnet-ef```

    ```dotnet add package Microsoft.EntityFrameworkCore.Design```

### #15 Kapcsolati stringek beállítása
- Connection string beállítása helyi gépen local db-re: 
    
    ```setx POSTGRESQLCONNSTR_NexxtRdb "Host=localhost;Username=somebody;Password=somepwd;```
    
    Felhasználónevet, jelszót cseréni kell arra, amit telepítéskor megadtunk. 
    Visual studiot újra kell indítani helyi environment variable változtatása után!
- Connection string beállítása helyi gépen azure db-re 
    
    ```setx POSTGRESQLCONNSTR_NexxtRdb "Host=nexxtpilotpgsql.postgres.database.azure.com;SSL Mode=Require;Trust Server Certificate=true;Username=develop;Password=gfdmkntrejG434fFDs;"```

    Visual studiot újra kell indítani helyi environment variable változtatása után!
- Connection string beállítása azire app service-ben
    
    Azure / PilotNexxtCore / Konfiguráció / Kapcsolati sztringek / új:

    Név: ```NexxtRdb```
    
    Érték: ```Host=nexxtpilotpgsql.postgres.database.azure.com;SSL Mode=Require;Trust Server Certificate=true;Username=develop;Password=gfdmkntrejG434fFDs;```

    Típus: ```PostgreSQL```

    Mentés, app service plan újraindítása

- Program a kapcsolati string végére még oda fogja fűzni, hogy ```;Database=NexxtPilot```

### #16 DbContext létrehozása
- #16\NexxtPilotContext.cs másolása Bl-be
- git commit

### #17 Init migration létrehozása
- bl könyvtárban futtatni: ```dotnet ef migrations add Init```

### #18 Admin controller létrehozása
Itt lesznek azok a fejelsztéshez szükséges kódok amikkel létrehozzuk letöröljük, feltöltjük az adatbázist.
- #18\NexxtPilotAdminController.cs másolása
- db létrehozása: ```/api/NexxtPilotAdmin/DatabaseEnsureDeletedMigratePopulate``` api végpont futtatása swaggerből
- teszt pgadmin: ```select * from "DemoProducts" p join "DemoProductExt" e on p."Id" = e."ProductId"```
- git commit

### #19 Db context továbbfejlesztése
kisbetűs db name convention, többesszámú táblanév convention, sql naplózás
- Nuget csomagok telepítése Bl-be:
    - ```EFCore.NamingConventions``` (6.0.0)
    - ```Pluralize.NET``` (Sarath KCM 1.0.2)
    - ```Microsoft.Extensions.Logging.Console``` (6.0.0)
- NexxtCore indítót átkapcsolni IIS expressre, hogy ne command ablakba naplózzon.
- NexxtCore / proprerties / launchSettings.json / "profiles" / "IIS Express" / "launchUrl": "",
- Context tuvábbfejlesztése kisbetű, többesszám, naplózás irányba. (Másolni Bl-be:)
    - #19\NexxtPilotContext.cs 
    - #19\ModelBuilderExtensions.cs 
- Migráció újragenerálás: Bl könyvtárban futtatni: 
    - ```rmdir /S /Q "Migrations"```
    - ```dotnet ef migrations add Init```
- teszt
    - swagger: ```DatabaseEnsureDeletedMigratePopulate``` (VS / Output / NexxtCore - ASP.NET Core Web Server- sqleket megnézni)
    - pgadmin:  ```select * from DemoProducts p join DemoProductExts e on p.Id = e.ProductId```

- git commit

### #20 Random adatok feltöltése
- #20\RandomProduct.cs másolása Blbe.
- NexxtPilotAdminController / DatabasePopulate átírása 
    
    (másolás: #20 NexxtPilotAdminController.cs )
- teszt:
    - swagger: ```DatabaseEnsureDeletedMigratePopulate``` (VS / Output / NexxtCore - ASP.NET Core Web Server- sqleket megnézni)
    - pgadmin:  ```select * from DemoProducts p join DemoProductExts e on p.Id = e.ProductId```

- git commit

### #21 DemoProduct controller Db kapcsolat
- DbContext dependency injection bekapcsolása Program.cs ben: ```builder.Services.AddDbContext<Bl.NexxtPilotContext>();```
- Controller átírása (DbContext Di használat, Iqueryable visszaadás ): #21\DemoProductController.cs 
- teszt Postman: ```https://localhost:44339/odata/DemoProduct?$top=10&$select=Name&$expand=Stocks($select=StoreId,Quantity)```
- git commit

### #22 VmDemoProductDemoInventoryStockController
- controller létrehozás
    (#22\VmDemoProductDemoInventoryStockController.cs)
- ViewModel létrehozás
    (#22\VmDemoProductDemoInventoryStock.cs)
- DbContext bővítés DemoInventoryStocks tábla felsorolásával 
    ```public DbSet<Models.DemoInventoryStock> DemoInventoryStocks { get; set; } = null!;```
- Odata Edm model bővítés
    ```builder.EntitySet<Models.VmDemoProductDemoInventoryStock>(nameof(Models.VmDemoProductDemoInventoryStock));```
- teszt Postman: ```https://localhost:44339/odata/VmDemoProductDemoInventoryStock?storeId=00000000-0000-0000-0053-746f72652030&$top=10&$expand=DemoProduct($select=Name),DemoInventoryStock($select=Quantity)```
- git commit

### #23 VmDemoProductDemoInventoryStockController szerver oldali általános szűrő
- controller upgrade
    (#23\VmDemoProductDemoInventoryStockController.cs)
- teszt Postman: ```https://localhost:44339/odata/VmDemoProductDemoInventoryStock?storeId=00000000-0000-0000-0053-746f72652030&$top=10&$expand=DemoProduct($select=Name),DemoInventoryStock($select=Quantity)&search=4```
- teszt Postman: ```https://localhost:44339/odata/VmDemoProductDemoInventoryStock?storeId=00000000-0000-0000-0053-746f72652030&$top=10&$expand=DemoProduct($select=Name),DemoInventoryStock($select=Quantity)&search=Ab``` (Aawwby gim apee (131): Quantity = 2)
- teszt Postman: ```https://localhost:44339/odata/VmDemoProductDemoInventoryStock?storeId=00000000-0000-0000-0053-746f72652030&$top=10&$expand=DemoProduct($select=Name;$expand=Stocks($select=StoreId,Quantity)),DemoInventoryStock($select=Quantity)&search=4```
- git commit
- Azure publish

------

--------------------


okos odata controller készítése
- megszakítható
- async futás
- adat hozzáférhetőség (létrehozás dátuma/ készlet)

dátum kezelés

keresési sorrend: szókezdet találat, belső szókezdet találat (hogy oldották meg Juhász Tamás és Konrád Gábor?)

index létrehozás
rekurzív navigation properties

kompozit adatvisszadás: ViewModel 

módosító odata


apache jmeter

postman

memória profil

jwt authentication


frontend illesztés
-------------------------------
Juhász Tamás, Konrád Gábor:
Sziasztok! Backend oktatást fogok tartani, szüségem lenne segítségre.
Elvileg ti (/ valamelyikőtök) hoztátok össze a tegnapelőtt bemutatott cikkkereső frontendet. Egy hasonlót kellene összehozni majd a backend bemutató számára. (jövő hét közepe környékén kellene ezt elkészíteni)
A másik az, hogy érdekelne, a technikai megvalósítása annak a problémának, hogy ha beírják az általános keresőbe, hogy "Kal" akkor előbb hozza a "Kal" kezdetű cikkeket, majd azokat, amiknek a cikknév közepében van "Kal" kezdetű szó. Ez utóbbi infóra a jövő hét elején lenne szükségem!
Előre is köszönöm a segítséget!

Simi  4:44 PM
Meg még van ez is:
- szeretném elérni, hogy a frontendben a devexpress táblázat általános keresője ne különböző adatmezőkre írjon odata szűrést, hanem adja át a az urlben search vagy $search paraméterben (ahogy azt a syncfusion komponens is csinálja.) Ha máshogy nem, a táblázaton le kell tiltani az általános keresőt, és fölé kell rakni egy saját készítésű bekérő mezőt, és az ott beírt adatot továbbadni...
- A frontendnek képesnek kell lennie arra, hogy pl a cikkeresőben a frontend által nyilvántartott kiválasztott raktár (pl comboboxban látszik az ablak tetején) Idjét átadja raktarid paraméterben.
- A frontend jó lenne, ha képes lenne kezelni azt, hogy ha lekérdez egy index nélküli táblázatot, ami másodpercekig számoltatja a backendet (és az adatbázist), és mielőtt választ kapnánk változik a lekérdezés, akkor a korábban elküldött odata lekérdezéseket szakítsa meg (hogy adatbázis ne számolja tovább, amire már nincs szükség).

----------
követelmények:
visual stidio 2022, asp.net 6, pgadmin, local postgresql, postman, apachge jmeter
